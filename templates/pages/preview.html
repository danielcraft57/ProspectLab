{% extends "base.html" %}

{% block title %}Prévisualisation - ProspectLab{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/campagnes.css') }}">
{% endblock %}

{% block content %}
<div class="preview-page">
<div class="page-header preview-page-header" data-filename="{{ filename }}" data-download-file-url="{{ url_for('other.download_file', filename='') }}" data-celery-workers="{{ celery_workers|default(4) }}">
    <h1>Prévisualisation du fichier</h1>
    <p class="preview-file-info">Fichier : <strong>{{ filename }}</strong> ({{ total_rows }} lignes)</p>
</div>

<div class="preview-stats-block">
    <h2 class="preview-stats-title">Résumé du fichier</h2>
    <div class="preview-stats-grid">
        <div class="preview-stat-item">
            <span class="preview-stat-value" id="preview-stat-total">{{ preview_stats.total|default(total_rows)|default(0) }}</span>
            <span class="preview-stat-label">Entreprises</span>
        </div>
        <div class="preview-stat-item">
            <span class="preview-stat-value">{{ preview_stats.with_website|default(0) }}</span>
            <span class="preview-stat-label">Avec site web</span>
        </div>
        <div class="preview-stat-item">
            <span class="preview-stat-value">{{ preview_stats.with_phone|default(0) }}</span>
            <span class="preview-stat-label">Avec téléphone</span>
        </div>
        <div class="preview-stat-item">
            <span class="preview-stat-value">{{ preview_stats.with_address|default(0) }}</span>
            <span class="preview-stat-label">Avec adresse</span>
        </div>
        <div class="preview-stat-item">
            <span class="preview-stat-value">{{ preview_stats.with_category|default(0) }}</span>
            <span class="preview-stat-label">Avec catégorie</span>
        </div>
    </div>
</div>

{% if validation_warnings %}
<div class="info-box" style="background-color: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 2rem;">
    <h3 style="color: #856404; margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle"></i> Avertissements de validation</h3>
    <p style="color: #856404; margin-bottom: 0.5rem;">Les erreurs suivantes ont été détectées dans votre fichier. Les lignes concernées seront ignorées lors de l'analyse :</p>
    <ul style="color: #856404; margin-left: 1.5rem;">
        {% for warning in validation_warnings %}
        <li>{{ warning }}</li>
        {% endfor %}
    </ul>
    {% if validation_warnings|length >= 10 %}
    <p style="color: #856404; margin-top: 0.5rem; font-style: italic;">... et d'autres erreurs (seules les 10 premières sont affichées)</p>
    {% endif %}
</div>
{% endif %}

<div class="analyze-section analyze-card">
    <h2>Lancer l'analyse</h2>
    
    <form id="analyze-form" class="analyze-form">
        <div class="form-group analyze-intro">
            <p>
                L'analyse utilise Celery avec {{ celery_workers|default(4) }} workers en parallèle pour une performance optimale.
            </p>
        </div>
        
        <div class="form-actions analyze-actions">
            <button type="submit" class="btn btn-primary" id="start-analysis-btn">Lancer l'analyse</button>
            <button type="button" class="btn btn-danger" id="stop-analysis-btn" style="display: none;">Arrêter l'analyse</button>
        </div>
    </form>
    
    <div id="analyze-status" class="status-message" style="display: none;"></div>
</div>

<div class="preview-section preview-card preview-collapsed" id="preview-section">
    <div class="preview-header">
        <div>
            <h2>Aperçu des données</h2>
            <p class="preview-subtitle">10 premières lignes sur {{ total_rows }} (pour vérifier que le mapping te convient).</p>
        </div>
        <button type="button" class="preview-toggle-btn" id="preview-toggle-btn" aria-expanded="false">
            <i class="fas fa-chevron-down preview-toggle-icon" aria-hidden="true"></i>
            <span class="preview-toggle-label">Afficher l'aperçu détaillé</span>
        </button>
    </div>
    <div class="preview-content" id="preview-content">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        {% for col in columns %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in preview %}
                    <tr>
                        {% for col in columns %}
                        <td>{{ row.get(col, '') }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/preview.js') }}" defer></script>
{% endblock %}

