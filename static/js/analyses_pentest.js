/**
 * JavaScript pour la page de liste des analyses Pentest
 */

(function() {
    let allAnalyses = [];
    
    document.addEventListener('DOMContentLoaded', () => {
        loadAnalyses();
        setupEventListeners();
        
        // Vérifier les paramètres d'URL pour auto-remplir et lancer l'analyse
        const urlParams = new URLSearchParams(window.location.search);
        const autoUrl = urlParams.get('url');
        const autoStart = urlParams.get('auto_start') === 'true';
        const entrepriseId = urlParams.get('entreprise_id');
        
        if (autoUrl) {
            // Préremplir le formulaire
            const urlInput = document.getElementById('pentest-url');
            
            if (urlInput) {
                urlInput.value = autoUrl;
            }
            
            // Nettoyer l'URL des paramètres
            if (autoStart) {
                // Attendre un peu que la page soit chargée puis lancer l'analyse
                setTimeout(() => {
                    if (urlInput && urlInput.value) {
                        // Pour le pentest, on utilise les options par défaut
                        const defaultOptions = {
                            sqlmap: true,
                            wpscan: false,
                            nikto: true,
                            wapiti: false,
                            security_headers: true,
                            ssl_tls: true
                        };
                        handleFormSubmit(new Event('submit'), autoUrl, defaultOptions, entrepriseId);
                    }
                }, 500);
            }
            
            // Nettoyer l'URL après traitement
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }
    });
    
    async function loadAnalyses() {
        try {
            const response = await fetch('/api/analyses-pentest');
            allAnalyses = await response.json();
            renderAnalyses();
        } catch (error) {
            console.error('Erreur lors du chargement des analyses:', error);
            document.getElementById('analyses-container').innerHTML = 
                '<p class="error">Erreur lors du chargement des analyses</p>';
        }
    }
    
    function renderAnalyses() {
        const container = document.getElementById('analyses-container');
        
        document.getElementById('results-count').textContent = 
            allAnalyses.length + ' analyse' + (allAnalyses.length > 1 ? 's' : '') + ' de sécurité trouvée' + (allAnalyses.length > 1 ? 's' : '');
        
        if (allAnalyses.length === 0) {
            container.innerHTML = '<p class="no-results">Aucune analyse de sécurité disponible</p>';
            return;
        }
        
        container.innerHTML = allAnalyses.map(analysis => createAnalysisCard(analysis)).join('');
        
        // Ajouter les event listeners pour les boutons "Voir détails"
        container.querySelectorAll('.btn-view-details').forEach(btn => {
            btn.addEventListener('click', function() {
                const analysisId = parseInt(this.getAttribute('data-analysis-id'));
                if (isNaN(analysisId)) {
                    console.error('ID d\'analyse invalide:', this.getAttribute('data-analysis-id'));
                    return;
                }
                openPentestModal(analysisId);
            });
        });
        
        // Ajouter les event listeners pour les boutons "Supprimer"
        container.querySelectorAll('.btn-delete-analysis').forEach(btn => {
            btn.addEventListener('click', function() {
                const analysisId = parseInt(this.getAttribute('data-analysis-id'));
                const url = this.getAttribute('data-url');
                if (confirm('Êtes-vous sûr de vouloir supprimer cette analyse Pentest ?')) {
                    deletePentestAnalysis(analysisId, url);
                }
            });
        });
    }
    
    async function deletePentestAnalysis(analysisId, url) {
        try {
            const response = await fetch(`/api/analyse-pentest/${analysisId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Erreur lors de la suppression');
            }
            
            const result = await response.json();
            showNotification(result.message || 'Analyse Pentest supprimée avec succès', 'success');
            
            // Recharger la liste
            loadAnalyses();
            
            // Fermer le modal si ouvert
            closePentestModal();
        } catch (error) {
            console.error('Erreur lors de la suppression:', error);
            showNotification('Erreur lors de la suppression: ' + error.message, 'error');
        }
    }
    
    function createAnalysisCard(analysis) {
        const date = new Date(analysis.date_analyse).toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const vulnsCount = analysis.vulnerabilities_count || 0;
        const riskScore = analysis.risk_score || 0;
        const riskLevel = getRiskLevel(riskScore);
        const riskColor = getRiskColor(riskLevel);
        const domain = analysis.domain || analysis.url || 'N/A';
        
        return `
            <div class="analysis-tech-card">
                <div class="card-header">
                    <h3>${escapeHtml(domain)}</h3>
                    <span class="date-badge">${date}</span>
                </div>
                <div class="card-body">
                    <p><strong>URL:</strong> <a href="${escapeHtml(analysis.url)}" target="_blank">${escapeHtml(analysis.url)}</a></p>
                    <p><strong>Vulnérabilités:</strong> <span class="badge badge-${riskColor}">${vulnsCount}</span></p>
                    <p><strong>Score de risque:</strong> <span class="badge badge-${riskColor}">${riskScore}/100 (${riskLevel})</span></p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-small btn-primary btn-view-details" data-analysis-id="${analysis.id}">Voir détails</button>
                    <button class="btn btn-small btn-danger btn-delete-analysis" data-analysis-id="${analysis.id}" data-url="${escapeHtml(analysis.url)}">Supprimer</button>
                </div>
            </div>
        `;
    }
    
    function getRiskLevel(score) {
        if (score >= 70) return 'Critique';
        if (score >= 40) return 'Élevé';
        if (score >= 20) return 'Moyen';
        return 'Faible';
    }
    
    function getRiskColor(level) {
        if (level === 'Critique') return 'error';
        if (level === 'Élevé') return 'error';
        if (level === 'Moyen') return 'warning';
        return 'success';
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function setupEventListeners() {
        const formNewPentest = document.getElementById('form-new-pentest');
        if (formNewPentest) {
            formNewPentest.addEventListener('submit', handleNewPentest);
        }
    }
    
    function handleNewPentest(e) {
        e.preventDefault();
        
        const url = document.getElementById('pentest-url').value.trim();
        
        if (!url) {
            alert('Veuillez saisir une URL');
            return;
        }
        
        // Vérifier l'autorisation
        if (!confirm('⚠️ ATTENTION: Vous confirmez avoir l\'autorisation écrite pour tester ce site ?\n\nCette action est soumise aux lois en vigueur.')) {
            return;
        }
        
        const options = {
            sqlmap: document.getElementById('pentest-sqlmap').checked,
            wpscan: document.getElementById('pentest-wpscan').checked,
            nikto: document.getElementById('pentest-nikto').checked,
            wapiti: document.getElementById('pentest-wapiti').checked,
            security_headers: true,
            ssl_tls: true
        };
        
        handleFormSubmit(e, url, options);
    }
    
    function handleFormSubmit(e, url, options, entrepriseId = null) {
        if (e) {
            e.preventDefault();
        }
        
        if (!url) {
            alert('Veuillez saisir une URL');
            return;
        }
        
        // Vérifier l'autorisation seulement si ce n'est pas un lancement automatique
        if (e && !confirm('⚠️ ATTENTION: Vous confirmez avoir l\'autorisation écrite pour tester ce site ?\n\nCette action est soumise aux lois en vigueur.')) {
            return;
        }
        
        // Désactiver le formulaire
        const btn = document.getElementById('btn-start-pentest');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const progressSection = document.getElementById('pentest-progress');
        const progressBar = document.getElementById('pentest-progress-bar');
        const progressMessage = document.getElementById('pentest-progress-message');
        
        if (btn) {
            btn.disabled = true;
        }
        if (btnText) {
            btnText.style.display = 'none';
        }
        if (btnLoading) {
            btnLoading.style.display = 'inline';
        }
        if (progressSection) {
            progressSection.style.display = 'block';
        }
        if (progressBar) {
            progressBar.style.width = '0%';
        }
        if (progressMessage) {
            progressMessage.textContent = 'Démarrage de l\'analyse de sécurité...';
        }
        
        // Initialiser WebSocket si nécessaire
        if (window.wsManager && window.wsManager.socket) {
            startPentestAnalysis(url, options, entrepriseId);
        } else if (typeof io !== 'undefined') {
            const socket = io();
            startPentestAnalysisWithSocket(socket, url, options, entrepriseId);
        } else {
            alert('WebSocket non disponible. Veuillez recharger la page.');
            resetForm();
        }
    }
    
    function startPentestAnalysis(url, options, entrepriseId = null) {
        if (window.wsManager && window.wsManager.socket) {
            window.wsManager.socket.emit('start_pentest_analysis', { 
                url: url, 
                options: options,
                entreprise_id: entrepriseId
            });
            
            // Écouter les événements
            window.wsManager.socket.on('pentest_analysis_progress', (data) => {
                updateProgress(data);
            });
            
            window.wsManager.socket.on('pentest_analysis_complete', (data) => {
                handleAnalysisComplete(data);
            });
            
            window.wsManager.socket.on('pentest_analysis_error', (data) => {
                handleAnalysisError(data);
            });
        }
    }
    
    function startPentestAnalysisWithSocket(socket, url, options, entrepriseId = null) {
        socket.emit('start_pentest_analysis', { 
            url: url, 
            options: options,
            entreprise_id: entrepriseId
        });
        
        socket.on('pentest_analysis_progress', (data) => {
            updateProgress(data);
        });
        
        socket.on('pentest_analysis_complete', (data) => {
            handleAnalysisComplete(data);
            socket.disconnect();
        });
        
        socket.on('pentest_analysis_error', (data) => {
            handleAnalysisError(data);
            socket.disconnect();
        });
    }
    
    function updateProgress(data) {
        const progressBar = document.getElementById('pentest-progress-bar');
        const progressMessage = document.getElementById('pentest-progress-message');
        
        if (progressBar) {
            progressBar.style.width = data.progress + '%';
        }
        if (progressMessage) {
            progressMessage.textContent = data.message || 'Analyse en cours...';
        }
    }
    
    function handleAnalysisComplete(data) {
        const progressBar = document.getElementById('pentest-progress-bar');
        const progressMessage = document.getElementById('pentest-progress-message');
        
        if (progressBar) {
            progressBar.style.width = '100%';
            progressBar.classList.add('success');
        }
        if (progressMessage) {
            progressMessage.textContent = 'Analyse de sécurité terminée !';
        }
        
        showNotification('Analyse de sécurité terminée ! Score de risque: ' + (data.risk_score || 0) + '/100', 'success');
        
        // Recharger la liste
        setTimeout(() => {
            loadAnalyses();
            resetForm();
            
            // Ouvrir automatiquement la modale avec les détails de l'analyse
            if (data.analysis_id) {
                setTimeout(() => {
                    openPentestModal(data.analysis_id);
                }, 500);
            }
        }, 1000);
    }
    
    function handleAnalysisError(data) {
        showNotification(data.error || 'Erreur lors de l\'analyse de sécurité', 'error');
        resetForm();
    }
    
    function resetForm() {
        const btn = document.getElementById('btn-start-pentest');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');
        const progressSection = document.getElementById('pentest-progress');
        
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        progressSection.style.display = 'none';
        document.getElementById('pentest-url').value = '';
    }
    
    // Fonctions pour la modale
    let currentPentestData = null;
    let currentPentestId = null;
    
    function openPentestModal(analysisId) {
        currentPentestId = analysisId;
        const modal = document.getElementById('pentest-modal');
        if (!modal) {
            console.error('Modal Pentest introuvable');
            return;
        }
        
        const modalBody = document.getElementById('pentest-modal-body');
        const modalTitle = document.getElementById('pentest-modal-title');
        const modalFooter = document.getElementById('pentest-modal-footer');
        
        // Afficher le modal
        modal.style.display = 'flex';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        if (modalBody) {
            modalBody.innerHTML = '<div class="loading">Chargement des détails...</div>';
        }
        if (modalFooter) {
            modalFooter.innerHTML = '';
        }
        
        loadPentestDetail(analysisId);
    }
    
    function closePentestModal() {
        const modal = document.getElementById('pentest-modal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        currentPentestData = null;
        currentPentestId = null;
    }
    
    async function loadPentestDetail(analysisId) {
        try {
            const response = await fetch('/api/analyse-pentest/' + analysisId);
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erreur HTTP:', response.status, errorText);
                throw new Error('Analyse Pentest introuvable');
            }
            
            currentPentestData = await response.json();
            renderPentestDetail();
        } catch (error) {
            console.error('Erreur lors du chargement:', error);
            const modalBody = document.getElementById('pentest-modal-body');
            if (modalBody) {
                modalBody.innerHTML = 
                    '<div class="error">Erreur lors du chargement des détails: ' + error.message + '</div>';
            }
        }
    }
    
    function renderPentestDetail() {
        if (!currentPentestData) return;
        
        const date = new Date(currentPentestData.date_analyse).toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        document.getElementById('pentest-modal-title').textContent = 
            'Analyse de sécurité - ' + (currentPentestData.domain || currentPentestData.url || 'Site web');
        
        const modalBody = document.getElementById('pentest-modal-body');
        modalBody.innerHTML = createPentestDetailHTML(date);
        
        // Ajouter les boutons dans le footer
        const modalFooter = document.getElementById('pentest-modal-footer');
        modalFooter.innerHTML = `
            <button class="btn btn-danger" id="btn-delete-pentest-analysis" data-analysis-id="${currentPentestId}" data-url="${currentPentestData.url}">Supprimer</button>
            <button class="btn btn-secondary" id="btn-close-pentest-modal">Fermer</button>
        `;
        
        // Event listener pour fermer
        document.getElementById('btn-close-pentest-modal').addEventListener('click', closePentestModal);
        
        // Event listener pour supprimer
        const deleteBtn = document.getElementById('btn-delete-pentest-analysis');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const analysisId = parseInt(this.getAttribute('data-analysis-id'));
                const url = this.getAttribute('data-url');
                if (confirm('Êtes-vous sûr de vouloir supprimer cette analyse Pentest ?')) {
                    deletePentestAnalysis(analysisId, url);
                }
            });
        }
    }
    
    function createPentestDetailHTML(date) {
        const vulnerabilities = currentPentestData.vulnerabilities || [];
        const summary = currentPentestData.pentest_details?.summary || {};
        const riskScore = currentPentestData.risk_score || 0;
        const riskLevel = getRiskLevel(riskScore);
        const riskColor = getRiskColor(riskLevel);
        
        return `
            <div class="detail-grid">
                <div class="detail-section">
                    <h3>Résumé</h3>
                    <div class="info-grid">
                        ${createInfoRow('URL', currentPentestData.url, true)}
                        ${createInfoRow('Domaine', currentPentestData.domain)}
                        ${createInfoRow('Date d\'analyse', date)}
                        ${createInfoRow('Score de risque', riskScore + '/100 (' + riskLevel + ')', false, 
                            '<span class="badge badge-' + riskColor + '">' + riskScore + '/100</span>')}
                        ${createInfoRow('Total vulnérabilités', summary.total_vulnerabilities || vulnerabilities.length)}
                        ${createInfoRow('Critiques', summary.critical_count || 0)}
                        ${createInfoRow('Élevées', summary.high_count || 0)}
                        ${createInfoRow('Moyennes', summary.medium_count || 0)}
                        ${createInfoRow('Faibles', summary.low_count || 0)}
                    </div>
                </div>
                
                ${vulnerabilities.length > 0 ? `
                <div class="detail-section full-width">
                    <h3>Vulnérabilités détectées (${vulnerabilities.length})</h3>
                    <div class="vulnerabilities-list">
                        ${vulnerabilities.map(vuln => `
                            <div class="vulnerability-item">
                                <div class="vuln-header">
                                    <span class="badge badge-${getSeverityColor(vuln.severity)}">${vuln.severity || 'Medium'}</span>
                                    <strong>${escapeHtml(vuln.type || 'Vulnérabilité')}</strong>
                                </div>
                                <div class="vuln-description">${escapeHtml(vuln.description || '')}</div>
                                ${vuln.details ? `<div class="vuln-details"><small>${escapeHtml(vuln.details)}</small></div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${currentPentestData.security_headers_analysis ? `
                <div class="detail-section">
                    <h3>En-têtes de sécurité</h3>
                    <div class="info-grid">
                        ${currentPentestData.security_headers_analysis.missing && currentPentestData.security_headers_analysis.missing.length > 0 ? `
                            <div class="info-row">
                                <span class="info-label">Manquants:</span>
                                <span class="info-value">
                                    ${currentPentestData.security_headers_analysis.missing.map(h => 
                                        '<span class="badge badge-error">' + escapeHtml(h.header) + '</span>'
                                    ).join(' ')}
                                </span>
                            </div>
                        ` : ''}
                        ${currentPentestData.security_headers_analysis.present && currentPentestData.security_headers_analysis.present.length > 0 ? `
                            <div class="info-row">
                                <span class="info-label">Présents:</span>
                                <span class="info-value">
                                    ${currentPentestData.security_headers_analysis.present.map(h => 
                                        '<span class="badge badge-success">' + escapeHtml(h.header) + '</span>'
                                    ).join(' ')}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                ${currentPentestData.ssl_tls_analysis ? `
                <div class="detail-section">
                    <h3>Analyse SSL/TLS</h3>
                    <div class="info-grid">
                        ${createInfoRow('Note', currentPentestData.ssl_tls_analysis.grade || 'N/A')}
                        ${currentPentestData.ssl_tls_analysis.vulnerabilities && currentPentestData.ssl_tls_analysis.vulnerabilities.length > 0 ? `
                            <div class="info-row">
                                <span class="info-label">Vulnérabilités:</span>
                                <span class="info-value">
                                    ${currentPentestData.ssl_tls_analysis.vulnerabilities.map(v => 
                                        '<span class="badge badge-error">' + escapeHtml(v.type) + '</span>'
                                    ).join(' ')}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function getSeverityColor(severity) {
        if (severity === 'Critical') return 'error';
        if (severity === 'High') return 'error';
        if (severity === 'Medium') return 'warning';
        return 'info';
    }
    
    function createInfoRow(label, value, isLink = false, customContent = null) {
        if (!value && !customContent) return '';
        
        const content = customContent || (isLink ? '<a href="' + value + '" target="_blank">' + escapeHtml(value) + '</a>' : escapeHtml(value));
        
        return `
            <div class="info-row">
                <span class="info-label">${label}:</span>
                <span class="info-value">${content}</span>
            </div>
        `;
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification notification-' + type;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
            color: white;
            border-radius: 4px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Event listeners pour fermer la modale
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('pentest-modal');
        const modalClose = document.getElementById('pentest-modal-close');
        const modalOverlay = modal?.querySelector('.modal-overlay');
        
        if (modalClose) {
            modalClose.addEventListener('click', closePentestModal);
        }
        
        if (modalOverlay) {
            modalOverlay.addEventListener('click', closePentestModal);
        }
        
        // Fermer avec la touche Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal?.classList.contains('active')) {
                closePentestModal();
            }
        });
    });
})();

